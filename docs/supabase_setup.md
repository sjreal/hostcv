# Supabase Setup Guide

This document explains how to set up Supabase for the CV Automation backend, covering database table creation and authentication configuration.

## 1. Prerequisites

-   A Supabase account ([https://supabase.com](https://supabase.com))
-   A new Supabase project created within your account

## 2. Obtain Credentials

Navigate to your Supabase project's settings to find your API URL and keys.

-   **Project URL:** Go to `Settings` -> `API` -> `Project URL`
-   **Service Role Key:** Go to `Settings` -> `API` -> `Project API keys` -> `service_role` key. **Important:** You must use the `service_role` key for the backend to have the necessary administrative privileges.

These values will be used in your `.env` file in the `Backend` directory.

```env
SUPABASE_URL=your_supabase_project_url
SUPABASE_KEY=your_supabase_service_role_key
```

## 3. Create Database Tables

Run the following SQL commands in your Supabase project's SQL Editor (`SQL Editor` -> `New query`) to create the necessary tables and indexes.

```sql
-- Create job_descriptions table
CREATE TABLE job_descriptions (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  job_id_str text,
  content_hash text UNIQUE NOT NULL,
  job_title text,
  company_name text,
  location text,
  ctc text,
  status text DEFAULT 'Active',
  details jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Create candidates table
CREATE TABLE candidates (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name text,
  email text UNIQUE,
  phone text,
  assessment_result text,
  recruiter_id uuid REFERENCES auth.users(id),
  uploaded_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Create analysis_results table
CREATE TABLE analysis_results (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  job_description_id bigint REFERENCES job_descriptions(id),
  candidate_id bigint REFERENCES candidates(id),
  user_id uuid REFERENCES auth.users(id),
  score real,
  match_level text,
  details jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Create indexes for better performance
CREATE INDEX job_descriptions_content_hash_idx ON job_descriptions (content_hash);
CREATE INDEX job_descriptions_job_id_str_idx ON job_descriptions (job_id_str);
CREATE INDEX job_descriptions_job_title_idx ON job_descriptions (job_title);
CREATE INDEX candidates_email_idx ON candidates (email);
CREATE INDEX analysis_results_job_description_id_idx ON analysis_results (job_description_id);
CREATE INDEX analysis_results_candidate_id_idx ON analysis_results (candidate_id);
CREATE INDEX analysis_results_user_id_idx ON analysis_results (user_id);
```

Alternatively, you can run the local Python script to see the required SQL commands:

```bash
cd Backend
uv run create_supabase_tables.py
```

## 4. Configure Authentication

The application uses Supabase Auth. You can manage users and authentication providers through the Supabase dashboard.

### Disable Email Confirmation (for Development)

For a smoother development experience, you can disable the email confirmation requirement for new users.

1.  Go to your Supabase project dashboard.
2.  Navigate to `Authentication` -> `Settings`.
3.  Turn off the **"Enable email confirmations"** toggle.

This allows new users to sign in immediately after registration. Remember to **re-enable this for production** to ensure security.

### User Roles

The application uses a `role` field to manage permissions. This role is stored in the user's `user_metadata`. When creating users (either through the UI or the `create_admin_user.py` script), a role such as `admin`, `recruiter`, or `backend_team` is assigned.

## 5. Test Authentication

After creating a user, you can test the authentication endpoint to ensure everything is configured correctly.

### Create an Admin User

First, run the `create_admin_user.py` script to create an admin user.

```bash
cd Backend
uv run create_admin_user.py
```

### Test the Token Endpoint

Use the following `curl` command to get an authentication token.

```bash
curl -X POST "http://localhost:8000/token" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "username=admin@cvautomation.com&password=password123"
```

### Access a Protected Route

Once you have a token, you can use it to access protected routes.

```bash
curl -H "Authorization: Bearer YOUR_TOKEN_HERE" http://localhost:8000/users/me
```
